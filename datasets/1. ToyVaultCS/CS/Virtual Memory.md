Виртуальная память — одна из самых гениальных идей в архитектуре вычислительных систем (введена в Manchester Atlas, 1962). Она даёт каждому процессу иллюзию собственного непрерывного адресного пространства и одновременно обеспечивает изоляцию и защиту.

### Основные функции виртуальной памяти
1. Изоляция процессов
2. Прозрачное использование диска как расширения ОЗУ (своп)
3. Защита памяти (NX-bit, user/supervisor)
4. Эффективное разделение памяти между процессами
5. Sparse address space (например, mmap огромных файлов)

### Механизм трансляции адресов (x86-64, 2025)
- 48-битный виртуальный адрес (реально 57-бит с 5-level paging)
- 4-уровневая (или 5-уровневая) таблица страниц (PML4 → PDPT → PD → PT)
- Размеры страниц: 4 КБ, 2 МБ, 1 ГБ (huge pages)
- Каждый уровень — 512 записей по 8 байт → 9 бит индекса на уровень

### Translation Lookaside Buffer (TLB)
TLB — это кэш трансляций страниц. Без него каждая инструкция требовала бы до 24 обращений к памяти.

Современные цифры (2025):
```markdown
| Процессор       | L1 DTLB                     | L2 STLB (unified) |
|-----------------|-----------------------------|-------------------|
| Intel Lunar Lake| 128 (4 КБ) + 16 (2 МБ/1 ГБ) | ~3072 записей     |
| AMD Zen 5       | 128 (4 КБ) + 16 (2 МБ)      | 3000+ записей     |
| Apple M4        | 128 (16 КБ страницы!)       | огромный unified  |
```

### Стоимость TLB miss
- L1 TLB hit: 1–2 такта
- L2 TLB hit: 7–20 тактов
- Page walk: 50–300 тактов + возможный page fault

### Huge pages и современные оптимизации
- 2 МБ и 1 ГБ страницы уменьшают давление на TLB в 512× и 262 144× соответственно
- Transparent Huge Pages (Linux) — автоматическое склеивание 4 КБ страниц
- 5-level paging (LA57) — до 128 ПиБ виртуального адреса
- ARM TTA (Translation Table Accelerator) и AMD’s Nested TLB

Виртуальная память и TLB — те немногие компоненты, где аппаратная и системная части архитектуры так глубоко переплетены. Изменения здесь (например, CXL memory, persistent memory, confidential computing) определяют облик вычислений на десятилетия вперёд.

См. также: [[Cache Hierarchy]]